# Домашнее задание к занятию 12.8. «Резервное копирование баз данных»

---

### Задание 1. Резервное копирование

1.1. Можно использовать инкрементальные либо дифференциальные бекапы. 

Плюсы: 
+ высокая скорость резервного копирования
+ меньше места для хранения
+ большое количество точек восстановления

Проблема инкрементальных в низкой скорости восстановления по сравнению с дифференциальным. (необходимо восстановить полную копию + все последующие блоки) + менее надежна (зависит от целостности всех блоков в цепочке)

1.2 Диффиренциальные бекапы - копируются не все исходные файлы, а только новые и измененные с момента создания предыдущей копии

Плюсы:
+ небольшой размер расностной резервной копии, по сравнению с полной
+ Скорость создаия в разы выше, чем полного бекапа
+ Для восстановления потребуется последний созданный полный бекап и последний диффиренциальный

Недостатки:
- избыточность данных, т.к. дифференциальный бекап является накопительным. 

Но для задачи сделать бекап данных за последний час и восстановить их подходит более чем. 

1.3
Организовывать репликацию БД - мастер -> слейв + снимать бекапы со слейва. 

При выходе из строя мастера:
1. Переключаем все запросы на слейв
2. Восстанавливаем в мастер бекап слейва
3. После восстановления бекапа переключаем запросы обратно на мастер

Поломку базы мониторим Zabbix'ом, при срабатывании триггера, что недоступна БД автоматически переключаемся на слейв. Либо руками восстанавливаем БД, либо по скрипту и возвращаем обратно запросы на мастер. 

---

### Задание 2. 

2.1 pg_dump dbname > dumpfile - делает дамп базы в файл, из которого потом можно восстановить БД. 
    
   Текстовые файлы, созданные pg_dump , предназначены для чтения программой psql .

   psql dbname < dumpfile - общая команда восстановления дампа в БД

   Здесь dumpfile - это файл, который вывела команда pg_dump. 

   dbname не создается при восстановлении, поэтому для начала надо создать БД командой **createdb -T template0 dbname**

2.2 башскрипт в крон по созданию БД с нужными параметрами. Выполнять дамп раз в сутки, например в 02:00.

 Можно также сразу перекладывать по scp с авторизацией по ключу на какую-нибудь машину для хранения дампов. 

---

### Задание 3. 

3.1 нужна утилита mysqlbackup

цитата из документации по [ссылке](https://dev.mysql.com/doc/mysql-enterprise-backup/4.1/en/mysqlbackup.incremental.html)
```
для описания параметров mysqlbackup , используемых для инкрементного резервного копирования. 

Инкрементное резервное копирование включается одним из двух вариантов: --incrementalи --incremental-with-redo-log-only параметром
```

В следующем примере --incremental-base=history:last_backup используется параметр, при котором mysqlbackup извлекает LSN последней успешной (не TTS) полной или частичной 

резервной копии из mysql.backup_historyтаблицы и на ее основе выполняет инкрементное резервное копирование.

```
mysqlbackup --defaults-file=/home/dbadmin/my.cnf \
  --incremental --incremental-base=history:last_backup \
  --backup-dir=/home/dbadmin/temp_dir \
  --backup-image=incremental_image1.bi \
   backup-to-image
```

3.2 Так же эту команду можно завернуть в баш скрипт и поставить в крон выполнять по таймеру. Перекладывать на хранилише через scp с авторизщацией по ключу